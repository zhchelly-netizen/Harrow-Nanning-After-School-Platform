# CCA 时间冲突处理功能

## 功能概述

当学生选择的 CCA 课程与已选的精英项目存在时间冲突时，系统会弹出对话框，提供两个选项：
1. **取消** - 放弃选择该 CCA 课程
2. **无视冲突强制添加** - 在确认与负责老师沟通后，强制添加该课程

如果选择强制添加，学生需要输入一行说明（最多200字），解释为什么可以同时参加这两个活动。这个说明会在最终的报名指引中显示，提醒学生与负责老师确认。

---

## 功能流程

### 1. 检测时间冲突

当学生点击选择 CCA 课程时，系统会自动检测：

```javascript
function checkCCAConflict(day, course) {
    // 如果是"不参加"，不检查冲突
    if (course.isOptOut) return null;
    
    // 转换日期格式
    const dayShortMap = {
        'monday': 'mon',
        'tuesday': 'tue',
        'wednesday': 'wed',
        'thursday': 'thu',
        'friday': 'fri'
    };
    const dayShort = dayShortMap[day];
    
    // 检查是否与精英项目冲突
    for (const program of selectedElitePrograms) {
        const scheduleInfo = ELITE_SCHEDULES[program.value];
        if (scheduleInfo && scheduleInfo.blocksWeekdays && scheduleInfo.days.includes(dayShort)) {
            return {
                type: 'elite',
                program: program.label,
                time: scheduleInfo.time
            };
        }
    }
    
    return null;
}
```

**检测逻辑：**
- 检查该天是否有精英项目训练
- 检查精英项目是否占用 CCA 时段（`blocksWeekdays: true`）
- 如果有冲突，返回冲突信息

---

### 2. 显示冲突对话框

如果检测到冲突，显示对话框：

**对话框内容：**
- ⚠️ 时间冲突提醒标题
- 显示两个冲突的活动：
  - CCA 课程名称和时间（16:00-17:00）
  - 精英项目名称和时间
- 输入框：让学生说明原因（必填，最多200字）
- 提示文字：
  - 💡 如果确认该安排已获得活动负责老师的允许，可以选择"强制添加"
  - 📋 请务必与活动负责老师确认该安排被允许，您的说明将显示在最终的报名指引中

**按钮：**
- 取消（灰色）
- 无视冲突强制添加（红色）

---

### 3. 强制添加逻辑

如果学生选择强制添加：

```javascript
function forceAddCCA() {
    const reason = document.getElementById('conflict-reason').value.trim();
    
    if (!reason) {
        alert('请说明强制添加的原因，以便在报名指引中显示。');
        return;
    }
    
    const { day, course, conflict } = window.tempConflictData;
    
    // 添加冲突覆盖信息
    const conflictOverride = {
        conflictWith: conflict.program,
        conflictTime: conflict.time,
        reason: reason,
        timestamp: new Date().toISOString()
    };
    
    // 确认选择
    confirmSelectCCA(day, course, conflictOverride);
    
    // 关闭对话框
    closeConflictDialog();
    
    // 显示成功消息
    showSuccessMessage('已添加课程，请确保与负责老师确认该安排');
}
```

**保存的数据结构：**
```javascript
selectedCCAs[day] = {
    id: 'mon-13',
    name: '小学部篮球 (体验)',
    teacher: '吉克',
    fee: '¥1,000',
    conflictOverride: {
        conflictWith: '🏆 篮球（小学）',
        conflictTime: '16:00-17:30',
        reason: '已与体育部张老师确认，篮球训练可以提前离开参加CCA课程',
        timestamp: '2026-01-22T10:30:00.000Z'
    }
}
```

---

### 4. 报名指引中显示冲突信息

在最后的报名指引页面（Step 5），如果有冲突覆盖的课程，会在最顶部显示特别提醒：

**显示内容：**

```
⚠️ 时间冲突特别提醒
您有以下课程存在时间冲突，请务必与负责老师确认

冲突 1：周一
┌─────────────────────────────────┐
│ 📚 CCA课程：小学部篮球 (体验)      │
│ 时间：16:00-17:00                │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│ 🏆 精英项目：篮球（小学）          │
│ 时间：16:00-17:30                │
└─────────────────────────────────┘

📝 您的说明：
"已与体育部张老师确认，篮球训练可以提前离开参加CCA课程"

⚠️ 重要：请与活动负责老师确认该安排被允许。报名时请在备注中说明此冲突情况。
```

---

## 使用场景示例

### 场景 1：篮球队员想参加体验课

**情况：**
- 学生已选择：🏆 小学部篮球队（周三、周五 16:00-17:30）
- 学生想选择：📚 小学部网球 (体验)（周三 16:00-17:00）

**冲突原因：**
- 周三 16:00-17:00 时段重叠

**解决方案：**
1. 系统弹出冲突对话框
2. 学生输入说明："已与篮球教练确认，周三可以提前15分钟离开训练参加网球体验课"
3. 强制添加
4. 在报名指引中显示此冲突和说明

---

### 场景 2：游泳队员想参加学术课程

**情况：**
- 学生已选择：🏆 游泳一队（周一、周三、周四、周六、周日 16:00-17:30）
- 学生想选择：📚 袋鼠数学（周四 16:00-17:00）

**冲突原因：**
- 周四 16:00-17:00 时段重叠

**解决方案：**
1. 系统弹出冲突对话框
2. 学生输入说明："已与游泳教练和数学老师确认，周四可以不参加游泳训练，优先参加学术竞赛课程"
3. 强制添加
4. 在报名指引中显示此冲突和说明

---

### 场景 3：音乐学院学生想参加CCA

**情况：**
- 学生已选择：🎵 钢琴（定制时间，不占用CCA时段）
- 学生想选择：📚 任何CCA课程

**结果：**
- ✅ 不会冲突，因为音乐学院课程 `blocksWeekdays: false`
- 直接选择，无需弹出对话框

---

## 技术实现细节

### 数据流

```
用户点击CCA课程
    ↓
selectCCA(day, course)
    ↓
checkCCAConflict(day, course)
    ↓
有冲突？
    ├─ 是 → showConflictDialog()
    │         ↓
    │    用户输入原因
    │         ↓
    │    forceAddCCA()
    │         ↓
    │    confirmSelectCCA(day, course, conflictOverride)
    │
    └─ 否 → confirmSelectCCA(day, course, null)
```

### 关键函数

1. **selectCCA(day, course)** - 选择CCA课程的入口
2. **checkCCAConflict(day, course)** - 检测时间冲突
3. **showConflictDialog(day, course, conflict)** - 显示冲突对话框
4. **forceAddCCA()** - 强制添加课程
5. **confirmSelectCCA(day, course, conflictOverride)** - 确认选择（内部函数）
6. **closeConflictDialog()** - 关闭对话框

### 数据结构

```javascript
// 冲突信息
conflict = {
    type: 'elite',
    program: '🏆 篮球（小学）',
    time: '16:00-17:30'
}

// 冲突覆盖信息
conflictOverride = {
    conflictWith: '🏆 篮球（小学）',
    conflictTime: '16:00-17:30',
    reason: '已与体育部张老师确认...',
    timestamp: '2026-01-22T10:30:00.000Z'
}

// 保存在 selectedCCAs 中
selectedCCAs[day] = {
    ...course,
    conflictOverride: conflictOverride  // 如果有冲突覆盖
}
```

---

## UI/UX 设计

### 对话框设计

**颜色方案：**
- 背景：白色
- 标题：红色 (#dc2626)
- 冲突区域：浅红色背景 (#fef2f2)
- 提示区域：浅黄色背景 (#fffbeb)
- 说明区域：浅蓝色背景 (#e0f2fe)

**交互：**
- 点击遮罩层不关闭对话框（防止误操作）
- 必须点击"取消"或"强制添加"按钮
- 输入框有字符计数（0/200）
- 输入框为空时点击"强制添加"会提示

### 报名指引设计

**布局：**
- 冲突提醒卡片在最顶部
- 使用渐变红色背景 (#fef2f2 → #fee2e2)
- 红色边框 (3px solid #dc2626)
- 每个冲突独立显示

**信息层次：**
1. 冲突标题（冲突 1：周一）
2. CCA 课程信息（黄色卡片）
3. 精英项目信息（红色卡片）
4. 学生说明（蓝色卡片）
5. 重要提醒（黄色卡片）

---

## 测试场景

### 测试 1：基本冲突检测

**步骤：**
1. 选择年级：G3
2. 选择精英项目：小学部篮球队（周三、周五）
3. 进入 CCA 选择
4. 尝试选择周三的任意 CCA 课程

**预期：**
- ✅ 弹出冲突对话框
- ✅ 显示篮球队和 CCA 课程的时间
- ✅ 输入框可以输入文字
- ✅ 字符计数正常工作

### 测试 2：强制添加

**步骤：**
1. 在冲突对话框中输入原因
2. 点击"无视冲突强制添加"

**预期：**
- ✅ 对话框关闭
- ✅ CCA 课程被选中
- ✅ 显示成功消息
- ✅ 浮动规划框更新

### 测试 3：取消操作

**步骤：**
1. 在冲突对话框中点击"取消"

**预期：**
- ✅ 对话框关闭
- ✅ CCA 课程未被选中
- ✅ 无任何数据变化

### 测试 4：空原因验证

**步骤：**
1. 在冲突对话框中不输入任何内容
2. 点击"无视冲突强制添加"

**预期：**
- ✅ 显示提示："请说明强制添加的原因"
- ✅ 对话框不关闭
- ✅ 课程未被添加

### 测试 5：报名指引显示

**步骤：**
1. 强制添加一个有冲突的 CCA 课程
2. 完成所有步骤
3. 进入报名指引页面

**预期：**
- ✅ 在顶部显示"时间冲突特别提醒"
- ✅ 显示冲突的详细信息
- ✅ 显示学生输入的说明
- ✅ 显示重要提醒

### 测试 6：多个冲突

**步骤：**
1. 选择多个精英项目（不同天）
2. 在多个有冲突的天选择 CCA 课程
3. 每个都强制添加

**预期：**
- ✅ 每个冲突都单独处理
- ✅ 报名指引中显示所有冲突
- ✅ 每个冲突的说明都正确显示

---

## 注意事项

### 1. 数据完整性

- 冲突覆盖信息必须包含：
  - `conflictWith` - 冲突的精英项目名称
  - `conflictTime` - 冲突的时间
  - `reason` - 学生的说明
  - `timestamp` - 添加时间

### 2. 用户体验

- 对话框必须清晰显示冲突信息
- 输入框必须有字符限制（200字）
- 必须验证输入不为空
- 成功添加后显示提示消息

### 3. 报名指引

- 冲突提醒必须在最顶部
- 必须使用醒目的颜色（红色）
- 必须显示学生的说明
- 必须提醒学生与老师确认

### 4. 边界情况

- "不参加"选项不检查冲突
- 定制时间的精英项目（`blocksWeekdays: false`）不检查冲突
- 周末的精英项目不影响工作日的 CCA 选择

---

## 未来优化

### 1. 时间段精确匹配

目前只检查是否在同一天，未来可以精确匹配时间段：
- CCA: 16:00-17:00
- 精英项目: 16:00-17:30
- 实际冲突: 16:00-17:00（1小时）

### 2. 自动建议

根据冲突情况，自动建议：
- "您可以选择其他天的课程"
- "以下课程与您的时间表兼容"

### 3. 老师确认

在系统中添加老师确认功能：
- 学生提交冲突说明
- 系统通知相关老师
- 老师在系统中确认或拒绝
- 学生收到确认结果

### 4. 历史记录

保存学生的冲突处理历史：
- 哪些冲突被批准
- 哪些冲突被拒绝
- 老师的反馈

---

**实现日期：** 2026年1月22日  
**版本：** v2.5 - 冲突处理功能
