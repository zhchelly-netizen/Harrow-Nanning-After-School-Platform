# Step 4 确认页面冲突显示优化

## 问题描述

在第四步（确认规划）页面，当学生选择的 CCA 课程与精英项目存在时间冲突时：
- ❌ 只显示一个活动（精英项目或 CCA，不是两个都显示）
- ❌ 没有冲突标记
- ❌ 无法看到完整的课程安排

## 解决方案

### 1. 数据结构改变

**之前：** `weekSchedule` 是对象，每天只能存一个活动
```javascript
weekSchedule[day] = {
    type: 'elite',
    name: '游泳队',
    fee: '定制课包'
}
```

**现在：** `weekSchedule` 是对象，每天存数组，可以存多个活动
```javascript
weekSchedule[day] = [
    {
        type: 'elite',
        name: '游泳队',
        fee: '定制课包'
    },
    {
        type: 'cca',
        name: '袋鼠数学',
        fee: '¥0',
        hasConflictOverride: true
    }
]
```

### 2. 修改的函数

#### `generateSummary()`
- 改为数组格式收集活动
- 显示每天的所有活动
- 添加冲突标记（红色徽章）
- 标记"已强制添加"的课程

#### `generateSchedulePreview()`
- 收集每天的所有活动（精英项目 + CCA）
- 检测冲突（同一天有多个非"不参加"的活动）
- 显示冲突卡片（红色渐变背景 + 红色边框）
- 在卡片右上角显示"⚠️ 冲突"徽章
- 每个活动独立显示在彩色背景块中

#### `generatePriceSummary()`
- 适配数组格式的 `weekSchedule`
- 遍历所有天的所有活动
- 标记有冲突覆盖的课程

#### `generateScheduleImage()`
- 检测每天是否有冲突
- 冲突卡片使用红色渐变背景
- 冲突卡片使用红色边框（4px）
- 在卡片右上角绘制"⚠️ 冲突"标记
- 多个活动之间添加分隔线
- 标记"已强制添加"的课程

---

## 视觉效果

### 正常卡片（无冲突）
```
┌─────────────────────────┐
│      周一 MON           │ ← 深蓝色标题
├─────────────────────────┤
│                         │
│   🏆 游泳队             │
│   16:00-17:30           │
│   定制课包              │
│                         │
└─────────────────────────┘
```

### 冲突卡片
```
┌─────────────────────────┐ ← 红色边框 (4px)
│      周一 MON    ⚠️冲突 │ ← 红色标题 + 冲突徽章
├─────────────────────────┤
│ ┌─────────────────────┐ │
│ │ 🏆 游泳队           │ │ ← 金色背景
│ │ 16:00-17:30         │ │
│ │ 定制课包            │ │
│ └─────────────────────┘ │
│ ─────────────────────── │ ← 分隔线
│ ┌─────────────────────┐ │
│ │ 📚 袋鼠数学         │ │ ← 红色背景
│ │ 16:00-17:00         │ │
│ │ ¥0                  │ │
│ │ (已强制添加)        │ │ ← 红色标记
│ └─────────────────────┘ │
└─────────────────────────┘
整个卡片：红色渐变背景 (#fef2f2 → #fee2e2)
```

---

## 课后时间安排列表显示

### 无冲突
```
周一 MON
  🏆 游泳队

周二 TUE
  📚 袋鼠数学
```

### 有冲突
```
周一 MON  ⚠️ 冲突
  🏆 游泳队
  📚 袋鼠数学 (已强制添加)
```

---

## 测试场景

### 测试 1：基本冲突显示

**步骤：**
1. 选择年级：G7
2. 选择精英项目：游泳一队（周一、周三、周四、周六、周日）
3. 在周一选择 CCA 课程（如：滑板）
4. 强制添加并输入原因
5. 进入第四步确认页面

**预期结果：**
- ✅ 周一显示两个活动：🏆 游泳队 + 📚 滑板
- ✅ 周一卡片有红色边框和红色背景
- ✅ 周一卡片右上角显示"⚠️ 冲突"
- ✅ 滑板课程标记"(已强制添加)"
- ✅ 课后时间安排列表显示"周一 MON ⚠️ 冲突"

### 测试 2：多天冲突

**步骤：**
1. 选择精英项目：游泳一队（周一、周三、周四）
2. 在周一、周三、周四都强制添加 CCA 课程
3. 进入第四步确认页面

**预期结果：**
- ✅ 周一、周三、周四都显示冲突标记
- ✅ 所有冲突天的卡片都是红色
- ✅ 每天都显示所有活动

### 测试 3：部分冲突

**步骤：**
1. 选择精英项目：游泳一队（周一、周三、周四）
2. 只在周一强制添加 CCA 课程
3. 周二、周五正常选择 CCA 课程
4. 进入第四步确认页面

**预期结果：**
- ✅ 周一：红色卡片，显示冲突
- ✅ 周二：正常卡片，只显示 CCA
- ✅ 周三：正常卡片，只显示游泳队
- ✅ 周四：正常卡片，只显示游泳队
- ✅ 周五：正常卡片，只显示 CCA

### 测试 4：下载课程表图片

**步骤：**
1. 创建有冲突的课程安排
2. 进入第五步
3. 点击"下载课程表与待办"

**预期结果：**
- ✅ 图片中冲突的天使用红色卡片
- ✅ 图片中显示"⚠️ 冲突"标记
- ✅ 图片中显示所有活动
- ✅ 图片中标记"(已强制添加)"

---

## 代码改动总结

### 文件：`scripts/cca.js`

**修改的函数：**
1. `generateSummary()` - 第 200-280 行
2. `generateSchedulePreview()` - 第 1100-1200 行
3. `generatePriceSummary()` - 第 350-450 行
4. `generateScheduleImage()` - 第 700-900 行

**关键改动：**
- 数据结构从对象改为数组
- 添加冲突检测逻辑
- 添加冲突视觉标记
- 支持同一天显示多个活动

---

## 注意事项

### 1. 向后兼容性
- 旧的数据格式（对象）会自动转换为新格式（数组）
- 不影响已有的功能

### 2. 性能
- 数组遍历增加了少量计算
- 对用户体验无影响

### 3. 数据完整性
- 确保所有活动都被正确收集
- 确保冲突检测准确

---

**修复日期：** 2026年1月22日  
**版本：** v2.6 - Step 4 冲突显示优化
